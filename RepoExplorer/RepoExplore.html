<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repo Explorer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🔧</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #2563eb; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .filter-btn { padding: 6px 12px; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; background-color: #e5e7eb; color: #374151; transition: all 0.2s ease-in-out; border: 1px solid transparent; cursor: pointer; }
        .filter-btn:hover { background-color: #d1d5db; }
        .active-filter, .active-filter:hover { background-color: #2563eb; color: white; font-weight: 600; border-color: transparent; }
        .adv-filter-tag { padding: 4px 10px; border-radius: 6px; font-size: 0.875rem; font-weight: 500; background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; transition: all 0.2s ease-in-out; cursor: pointer; text-align: center; outline: 2px solid transparent; outline-offset: 1px; }
        .adv-filter-tag:hover { border-color: #9ca3af; background-color: #e5e7eb; }
        .active-adv-filter, .active-adv-filter:hover { background-color: #dbeafe; color: #1e40af; border-color: #3b82f6; outline-color: #60a5fa; }
        .file-item { outline: 2px solid transparent; outline-offset: 1px; }
        .active-explorer-item, .active-explorer-item:hover { background-color: #dcfce7 !important; border-color: #22c55e !important; outline-color: #4ade80 !important; }
        .main-container-bg { background-color: #ffffff; background-image: radial-gradient(#f3f4f6 1px, transparent 1px); background-size: 16px 16px; }
        .override-tag { padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 500; background-color: #374151; color: #d1d5db; border: 1px solid #4b5563; transition: all 0.2s ease-in-out; cursor: pointer; outline: 2px solid transparent; outline-offset: 1px; }
        .override-tag:hover { border-color: #6b7280; background-color: #4b5563; }
        .active-override, .active-override:hover { background-color: #1d4ed8; color: #eff6ff; border-color: #3b82f6; outline-color: #60a5fa; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen p-4">

    <div class="w-full max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 main-container-bg">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Repo Explorer</h1>
            <p class="text-gray-500 mt-1">Intelligently browse repository files and folders.</p>
        </header>

        <form id="repoForm" class="flex flex-col sm:flex-row gap-3 mb-4">
            <input type="url" id="repoUrl"
                   placeholder="e.g., https://repo.radeon.com/rocm/manylinux/rocm-rel-7.0/"
                   required
                   class="flex-grow w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
            <button type="submit"
                    class="bg-blue-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 transform hover:scale-105">
                Explore
            </button>
        </form>
        
        <div id="navigation" class="hidden items-center justify-between bg-gray-50 p-3 rounded-lg mb-4 min-w-0">
            <button id="backButton" class="flex items-center gap-2 text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/></svg>
                Back
            </button>
            <div id="breadcrumbs" class="text-xs text-gray-500 truncate min-w-0 ml-4"></div>
        </div>

        <div class="md:flex justify-between items-start mb-4 gap-4">
            <div id="filterControls" class="flex flex-wrap gap-2 mb-4 md:mb-0"></div>
            <div class="flex items-center gap-3 justify-end flex-shrink-0">
                 <button id="generatePipBtn" class="filter-btn bg-green-600 text-white hidden" title="Generate pip command for selected packages">Generate Command</button>
                <button id="advancedFilterBtn" class="filter-btn hidden" title="Filter by package name">Advanced</button>
                <div id="viewControls" class="flex items-center gap-3 hidden">
                    <label for="showAllToggle" class="text-sm font-medium text-gray-700">Show all versions</label>
                    <div class="relative inline-block w-10 align-middle select-none">
                        <input type="checkbox" name="showAllToggle" id="showAllToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="showAllToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="advancedPackageFilterContainer" class="hidden w-full grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 mb-4 p-4 bg-gray-50/50 rounded-lg border"></div>

        <div id="results" class="mt-4">
            <div id="message" class="text-center text-gray-500 p-8 sm:p-12">
                <svg class="mx-auto h-20 w-20 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg>
                <h3 class="mt-4 text-xl font-bold text-gray-800">Explore Any Repository</h3>
                <p class="mt-2 text-md text-gray-500">Just paste a URL to begin. <br class="hidden sm:block"> I'll remember it for your next visit.</p>
            </div>
            <div id="loading" class="hidden text-center p-8">
                <div class="spinner mx-auto"></div>
                <p class="mt-4 text-gray-600">Fetching repository contents...</p>
            </div>
            <div id="fileList" class="flex flex-col gap-2"></div>
        </div>
    </div>

    <div id="modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-70 z-40"></div>
    <div id="mockConsole" class="hidden fixed inset-0 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-900 text-white rounded-lg shadow-2xl w-full max-w-4xl font-mono text-sm border-2 border-gray-700">
            <div class="bg-gray-800/50 px-4 py-2 flex items-center justify-between rounded-t-lg border-b border-gray-700">
                <div class="flex items-center gap-2"><span class="w-3 h-3 bg-red-500 rounded-full"></span><span class="w-3 h-3 bg-yellow-500 rounded-full"></span><span class="w-3 h-3 bg-green-500 rounded-full"></span></div>
                <span class="text-gray-400 font-bold">Smart Install Command</span>
                <button id="closeConsole" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                <div class="bg-black p-4 rounded mb-4 text-base overflow-x-auto"><span class="text-green-400 mr-2">user@linux:~$</span><code id="commandText" class="text-white break-words"></code></div>
                <div class="font-sans border-t border-gray-700 pt-4">
                    <h4 class="text-gray-400 font-bold mb-2 text-xs uppercase tracking-wider">Overrides</h4>
                    <div id="flagToggles" class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                        <button data-flag="--find-links-mode" class="override-tag" title="Use package names with --find-links instead of direct URLs. Lets pip choose the best file.">Use --find-links</button>
                        <button data-flag="-U" class="override-tag active-override" title="Upgrade packages to the newest available version.">-U, --upgrade</button>
                        <button data-flag="--force-reinstall" class="override-tag" title="Reinstall all packages even if they are already up-to-date.">--force-reinstall</button>
                        <button data-flag="--no-deps" class="override-tag" title="Don't install package dependencies.">--no-deps</button>
                        <button data-flag="--pre" class="override-tag" title="Include pre-release and development versions.">--pre</button>
                        <button data-flag="--ignore-installed" class="override-tag" title="Ignore the installed packages, overwriting them.">--ignore-installed</button>
                        <button data-flag="--no-cache-dir" class="override-tag" title="Disable the cache, force fresh download.">--no-cache-dir</button>
                        <button data-flag="--use-pep517" class="override-tag" title="Use PEP 517 for building source distributions.">--use-pep517</button>
                    </div>
                </div>
                <div class="mt-6 text-right"><button id="copyCommand" class="bg-blue-600 text-white text-sm font-sans font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 transition-all duration-200 transform hover:scale-105">Copy Command</button></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- PROXY MANAGER ---
            // Manages CORS proxies, tracking performance to prioritize reliable ones.
            const proxyManager = (() => {
                const PROXY_KEY = 'repoExplorerProxies';
                const baseProxies = [ 'https://api.allorigins.win/raw?url=', 'https://cors.eu.org/', 'https://corsproxy.io/?' ];
                let proxies = [];
                function load() {
                    try { const stored = JSON.parse(localStorage.getItem(PROXY_KEY) || '[]'); const storedUrls = new Set(stored.map(p => p.url)); const newProxies = baseProxies.filter(url => !storedUrls.has(url)); proxies = [...stored, ...newProxies.map(url => ({ url, successes: 0, failures: 0, avgTime: 0 }))]; save(); } catch (e) { proxies = baseProxies.map(url => ({ url, successes: 0, failures: 0, avgTime: 0 })); }
                }
                function save() { localStorage.setItem(PROXY_KEY, JSON.stringify(proxies)); }
                function getBest() { return [...proxies].sort((a, b) => { const scoreA = a.successes / (a.successes + a.failures + 1); const scoreB = b.successes / (b.successes + b.failures + 1); if (scoreB !== scoreA) return scoreB - scoreA; return a.avgTime - b.avgTime; }); }
                function report(url, success, time) { const proxy = proxies.find(p => p.url === url); if (!proxy) return; if (success) { proxy.successes++; const total_time = proxy.avgTime * (proxy.successes - 1); proxy.avgTime = (total_time + time) / proxy.successes; } else { proxy.failures++; } save(); }
                load();
                return { getBest, report };
            })();

            // --- STATE & DOM ---
            const state = { historyStack: [], allItems: [], advancedFilters: new Set(), selectedPackages: new Map() };
            const dom = { form: document.getElementById('repoForm'), urlInput: document.getElementById('repoUrl'), messageDiv: document.getElementById('message'), loadingDiv: document.getElementById('loading'), fileListContainer: document.getElementById('fileList'), navigationDiv: document.getElementById('navigation'), backButton: document.getElementById('backButton'), breadcrumbsDiv: document.getElementById('breadcrumbs'), filterControlsContainer: document.getElementById('filterControls'), viewControlsContainer: document.getElementById('viewControls'), showAllToggle: document.getElementById('showAllToggle'), advancedFilterBtn: document.getElementById('advancedFilterBtn'), advancedPackageFilterContainer: document.getElementById('advancedPackageFilterContainer'), generatePipBtn: document.getElementById('generatePipBtn'), modalBackdrop: document.getElementById('modal-backdrop'), mockConsole: document.getElementById('mockConsole'), closeConsoleBtn: document.getElementById('closeConsole'), commandTextSpan: document.getElementById('commandText'), copyCommandBtn: document.getElementById('copyCommand'), flagToggles: document.getElementById('flagToggles') };

            // --- INITIALIZATION ---
            function init() {
                setupEventListeners();
                loadLastRepoUrl();
            }

            // --- EVENT LISTENERS & HANDLERS ---
            function setupEventListeners() {
                dom.form.addEventListener('submit', handleRepoFormSubmit);
                dom.backButton.addEventListener('click', handleBackButtonClick);
                dom.showAllToggle.addEventListener('change', () => renderFileList());
                dom.advancedFilterBtn.addEventListener('click', () => { dom.advancedFilterBtn.classList.toggle('active-filter'); dom.advancedPackageFilterContainer.classList.toggle('hidden'); });
                dom.filterControlsContainer.addEventListener('click', handlePythonFilterClick);
                dom.advancedPackageFilterContainer.addEventListener('click', handlePackageFilterClick);
                dom.generatePipBtn.addEventListener('click', handleGenerateCommandClick);
                dom.flagToggles.addEventListener('click', handleFlagToggleClick);
                dom.fileListContainer.addEventListener('click', handleFileItemClick);
                dom.closeConsoleBtn.addEventListener('click', () => closeModal(dom.mockConsole));
                dom.modalBackdrop.addEventListener('click', () => closeModal(dom.mockConsole));
                dom.copyCommandBtn.addEventListener('click', handleCopyCommand);
            }
            
            function handleRepoFormSubmit(e) { e.preventDefault(); const url = dom.urlInput.value.trim(); if (!url.match(/^https?:\/\//)) { alert('Please enter a valid HTTP or HTTPS URL.'); return; } localStorage.setItem('lastRepoUrl', url); state.historyStack = [url]; fetchAndDisplayRepo(url, true); }
            function handleBackButtonClick() { if (state.historyStack.length > 1) { state.historyStack.pop(); fetchAndDisplayRepo(state.historyStack[state.historyStack.length - 1]); } }
            function handlePythonFilterClick(e) { const btn = e.target.closest('button'); if (!btn) return; const allBtn = dom.filterControlsContainer.querySelector('[data-version="All"]'); if (btn.dataset.version === 'All') { dom.filterControlsContainer.querySelectorAll('button').forEach(b => b.classList.remove('active-filter')); btn.classList.add('active-filter'); } else { allBtn.classList.remove('active-filter'); btn.classList.toggle('active-filter'); } if (!dom.filterControlsContainer.querySelector('.active-filter:not([data-version="All"])')) allBtn.classList.add('active-filter'); renderFileList(); }
            function handlePackageFilterClick(e) { const btn = e.target.closest('button'); if (btn) { const name = btn.dataset.packageName; btn.classList.toggle('active-adv-filter'); state.advancedFilters.has(name) ? state.advancedFilters.delete(name) : state.advancedFilters.add(name); renderFileList(); } }
            function handleGenerateCommandClick() { if (state.selectedPackages.size > 0) { updateCommandText(); openModal(dom.mockConsole); } }
            function handleFlagToggleClick(e) { const btn = e.target.closest('button'); if (btn) { btn.classList.toggle('active-override'); updateCommandText(); } }
            function handleFileItemClick(e) { const itemEl = e.target.closest('.file-item'); if (!itemEl || itemEl.tagName === 'A') return; const { url, type, name } = itemEl.dataset; if (type === 'directory') { state.historyStack.push(url); fetchAndDisplayRepo(url); } else if (type === 'package') { if (state.selectedPackages.has(url)) { state.selectedPackages.delete(url); } else { state.selectedPackages.set(url, name); } updatePipBtnVisibility(); itemEl.classList.toggle('active-explorer-item'); } }
            function handleCopyCommand() { navigator.clipboard.writeText(dom.commandTextSpan.textContent).then(() => { dom.copyCommandBtn.textContent = 'Copied!'; setTimeout(() => { dom.copyCommandBtn.textContent = 'Copy Command'; }, 1500); }).catch(err => console.error('Clipboard copy failed:', err)); }
            
            // --- CORE LOGIC & PARSING ---
            async function fetchAndDisplayRepo(url, isNewRepo = false) {
                if (!url.endsWith('/')) url += '/';
                updateUIState('loading');
                updateNavigation(url);
                if (isNewRepo) state.selectedPackages.clear();
                const sortedProxies = proxyManager.getBest();
                for (const proxy of sortedProxies) {
                    const fullUrl = `${proxy.url}${proxy.url.includes('?') ? encodeURIComponent(url) : url}`;
                    const startTime = performance.now();
                    try { const response = await fetch(fullUrl); if (!response.ok) throw new Error(`${response.status}`); const html = await response.text(); proxyManager.report(proxy.url, true, performance.now() - startTime); parseAndRender(html, url); return; } catch (error) { proxyManager.report(proxy.url, false, performance.now() - startTime); }
                }
                updateUIState('message', `Failed to fetch repository. All CORS proxies failed.`);
            }

            function parseAndRender(html, baseUrl) {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const links = Array.from(doc.querySelectorAll('a'));
                if (links.length === 0) { updateUIState('message', 'No readable files or directories found.'); return; }
                const rawItems = links.map(link => {
                    const href = link.getAttribute('href');
                    if (!href || href.startsWith('?') || href.startsWith('#') || href === '../' || link.textContent.trim().toLowerCase().includes('parent directory')) return null;
                    const url = new URL(href, baseUrl).href;
                    if (url === baseUrl) return null;
                    const isExternal = new URL(url).hostname !== new URL(baseUrl).hostname; const isDirectory = !isExternal && href.endsWith('/'); const name = decodeURIComponent(new URL(url).pathname.split('/').filter(Boolean).pop() || '');
                    return { name, url, isDirectory, isExternal, parsed: parseGenericFilename(name) };
                }).filter(Boolean);
                if (rawItems.length === 0) { updateUIState('message', 'No readable files or directories found.'); return; }
                state.allItems = groupMetadataFiles(rawItems);
                state.advancedFilters.clear();
                updatePipBtnVisibility();
                updateUIState('content');
                setupFilters();
                renderFileList();
            }
            
            function parseGenericFilename(name) {
                const parsers = {
                    WHEEL: { re: /^(.*?)-([^-]+?)-((?:py|cp)\d+)-([^-]+)-(.*)\.whl$/, action: m => { let [, name, version, pythonTag] = m; let python = pythonTag; if (pythonTag.startsWith('cp') || pythonTag.startsWith('py')) { const v = pythonTag.substring(2); python = `Py ${v[0]}.${v.length > 2 && v.startsWith('31') ? v.substring(1,3) : v.substring(1,2)}`; } return { name, version, python }; } },
                    DEB:   { re: /^(.*?)_([\d.\-~]+(?:-?\d+))_.*?\.deb$/, action: m => ({ name: m[1] || name, version: m[2] || 'N/A' }) },
                    RPM:   { re: /^(.*?)-(\d+.*)-\d+\..*?\.rpm$/, action: m => ({ name: m[1] || name, version: m[2] || 'N/A' }) },
                    ARCHIVE: { re: /^(.*?)-([\d.]+.*?)\.(?:tar\.gz|tgz|zip|tar\.bz2|tar\.xz)$/, action: m => ({ name: m[1] || name, version: m[2] || 'N/A' }) }
                };
                for (const type in parsers) { const match = name.match(parsers[type].re); if (match) return { isParsed: true, fileType: type, ...parsers[type].action(match) }; }
                return { isParsed: false, fileType: 'FILE', name };
            }

            // --- UI & RENDERING ---
            function updateUIState(viewState, text = '') { dom.messageDiv.classList.add('hidden'); dom.loadingDiv.classList.add('hidden'); if (viewState !== 'content') { dom.fileListContainer.innerHTML = ''; dom.filterControlsContainer.innerHTML = ''; dom.viewControlsContainer.classList.add('hidden'); dom.advancedFilterBtn.classList.add('hidden'); dom.advancedPackageFilterContainer.classList.add('hidden'); dom.advancedFilterBtn.classList.remove('active-filter'); dom.generatePipBtn.classList.add('hidden'); } if (viewState === 'loading') dom.loadingDiv.classList.remove('hidden'); else if (viewState === 'message') { dom.messageDiv.innerHTML = `<p class="p-8 text-red-500">${sanitizeHTML(text)}</p>`; dom.messageDiv.classList.remove('hidden'); dom.navigationDiv.classList.add('hidden'); } else if (viewState === 'content') dom.navigationDiv.classList.remove('hidden'); else if (viewState === 'initial') { dom.messageDiv.innerHTML = `<svg class="mx-auto h-20 w-20 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg><h3 class="mt-4 text-xl font-bold text-gray-800">Explore Any Repository</h3><p class="mt-2 text-md text-gray-500">Just paste a URL to begin. <br class="hidden sm:block"> I'll remember it for your next visit.</p>`; dom.messageDiv.classList.remove('hidden'); } }
            function setupFilters() { const py = [...new Set(state.allItems.map(i=>i.parsed.python).filter(Boolean))].sort((a,b)=>a.localeCompare(b,void 0,{numeric:!0})); const pkgs = [...new Set(state.allItems.filter(i=>i.parsed.isParsed).map(i=>i.parsed.name))].sort(); dom.filterControlsContainer.innerHTML = py.length > 0 ? ['All', ...py].map(v => `<button class="filter-btn ${v==='All'?'active-filter':''}" data-version="${v}">${sanitizeHTML(v)}</button>`).join('') : ''; dom.advancedFilterBtn.classList.toggle('hidden', pkgs.length === 0); dom.advancedPackageFilterContainer.innerHTML = pkgs.length > 0 ? pkgs.map(n => `<button class="adv-filter-tag" data-package-name="${sanitizeHTML(n)}">${sanitizeHTML(n)}</button>`).join('') : ''; }
            function renderFileList() { const pyVers = new Set([...dom.filterControlsContainer.querySelectorAll('.active-filter')].map(b=>b.dataset.version)); const advActive = state.advancedFilters.size > 0; const items = dom.showAllToggle.checked ? [...state.allItems] : getLatestVersions(state.allItems); const filtered = items.filter(i => (i.parsed.isParsed && (!advActive || state.advancedFilters.has(i.parsed.name)) && (pyVers.has('All') || pyVers.has(i.parsed.python))) || (!i.parsed.isParsed && !advActive)).sort((a, b) => (a.isDirectory !== b.isDirectory) ? (a.isDirectory ? -1 : 1) : (a.isExternal !== b.isExternal) ? (a.isExternal ? 1 : -1) : a.name.localeCompare(b.name, void 0, { numeric: !0 })); dom.fileListContainer.innerHTML = filtered.map(item => createFileItemHTML(item)).join(''); dom.viewControlsContainer.classList.toggle('hidden', !state.allItems.some(i => i.parsed.isParsed)); }
            function createFileItemHTML(item) {
                const { name, url, isDirectory, isExternal, parsed, metadataFiles } = item;
                const icons = { FOLDER: '📁', WHEEL: '⚙️', DEB: '📦', RPM: '📦', ARCHIVE: '🗜️', FILE: '📄', EXTERNAL: '🔗' };
                const s = sanitizeHTML; // Alias for brevity
                const metaBadges = (metadataFiles || []).map(m => `<span class="font-semibold bg-gray-200 text-gray-800 px-2 py-1 rounded-full text-xs">${s(m.type)}</span>`).join('');
                if (isExternal) return `<a href="${s(url)}" target="_blank" rel="noopener noreferrer" class="file-item flex items-center justify-between bg-white border rounded-lg p-3 transition-all duration-200 hover:shadow-md hover:border-indigo-500"><div class="flex items-center gap-3"><span>${icons.EXTERNAL}</span><span class="font-semibold text-gray-700 break-all">${s(name)}</span></div></a>`;
                const isSelected = state.selectedPackages.has(url);
                let type, content, classes;
                if (isDirectory) { type='directory'; content=`<div class="flex items-center gap-3"><span>${icons.FOLDER}</span><span class="font-semibold text-gray-700 break-all">${s(name)}</span></div>`; classes='cursor-pointer'; }
                else if (parsed.isParsed) { type='package'; content=`<div class="flex-grow min-w-0"><h3 class="font-bold text-md text-gray-900 truncate" title="${s(name)}"><span>${icons[parsed.fileType]}</span> ${s(parsed.name)}</h3><p class="text-xs text-gray-500 break-all ml-7">${s(parsed.version)}</p></div><div class="flex items-center gap-2 ml-4 flex-shrink-0">${metaBadges}${parsed.python ? `<span class="font-semibold bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">${s(parsed.python)}</span>` : ''}</div>`; classes=`cursor-pointer ${isSelected?'active-explorer-item':''}`; }
                else { type='file'; content=`<div class="flex items-center gap-3"><span>${icons.FILE}</span><h3 class="font-semibold text-gray-700 truncate" title="${s(name)}">${s(name)}</h3></div><div class="flex items-center gap-2 ml-4 flex-shrink-0">${metaBadges}</div>`; classes='cursor-default'; }
                return `<div class="file-item flex items-center justify-between bg-white border rounded-lg p-3 transition-all duration-200 hover:shadow-md ${classes}" data-url="${s(url)}" data-type="${type}" data-name="${s(parsed.name || '')}">${content}</div>`;
            }
            function updateNavigation(url) { const canBack = state.historyStack.length > 1; dom.backButton.disabled = !canBack; dom.backButton.classList.toggle('opacity-50', !canBack); try { const u = new URL(url); dom.breadcrumbsDiv.innerHTML = `<span class="font-semibold text-gray-700">${sanitizeHTML(u.hostname)}</span> &rsaquo; ${sanitizeHTML(u.pathname.split('/').filter(p=>p).join(' &rsaquo; '))}`; } catch(e) { dom.breadcrumbsDiv.textContent = url; } }
            function updatePipBtnVisibility() { const count = state.selectedPackages.size; dom.generatePipBtn.classList.toggle('hidden', count === 0); if (count > 0) dom.generatePipBtn.textContent = `Generate Command (${count})`; }
            function updateCommandText() { if (state.selectedPackages.size === 0) return; const findLinks = dom.flagToggles.querySelector('[data-flag="--find-links-mode"]').classList.contains('active-override'); const flags = [...dom.flagToggles.querySelectorAll('button.active-override')].map(b => b.dataset.flag).filter(f => f !== '--find-links-mode').join(' '); let pkgs; if (findLinks) { const names = [...new Set(state.selectedPackages.values())].map(n => `"${n}"`).join(' '); const repo = state.historyStack[state.historyStack.length - 1]; pkgs = `${names} --find-links ${decodeURIComponent(repo)}`; } else { pkgs = [...state.selectedPackages.keys()].map(u => `"${decodeURIComponent(u)}"`).join(' '); } dom.commandTextSpan.textContent = `python -m pip install ${flags} ${pkgs}`.replace(/\s+/g, ' ').trim(); }

            // --- HELPERS ---
            function loadLastRepoUrl() { const url = localStorage.getItem('lastRepoUrl'); if (url) dom.urlInput.value = url; else updateUIState('initial'); }
            function getLatestVersions(items) { const pkgs={}; const others=[]; items.forEach(i => { if (i.parsed.isParsed) { const n=i.parsed.name; if (!pkgs[n]) pkgs[n]=[]; pkgs[n].push(i); } else { others.push(i); } }); const latest=[]; for(const n in pkgs){ const newest=pkgs[n].reduce((a,b)=>a.parsed.version.localeCompare(b.parsed.version,void 0,{numeric:!0})>0?a:b); latest.push(...pkgs[n].filter(i=>i.parsed.version===newest.parsed.version)); } return [...others, ...latest]; }
            function groupMetadataFiles(items) { const grouped = []; const consumed = new Set(); const metaExts = ['.asc', '.sig', '.sha256', '.md5']; items.forEach(item => { if (consumed.has(item.url) || metaExts.some(ext => item.name.endsWith(ext))) return; item.metadataFiles = []; for (const ext of metaExts) { const metaFile = items.find(other => other.name === item.name + ext); if (metaFile) { item.metadataFiles.push({ type: ext.substring(1).toUpperCase(), url: metaFile.url }); consumed.add(metaFile.url); } } grouped.push(item); consumed.add(item.url); }); return grouped; }
            function sanitizeHTML(str) { return str.replace(/[&<>"']/g, (m) => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' })[m]); }
            function openModal(modal) { dom.modalBackdrop.classList.remove('hidden'); modal.classList.remove('hidden'); }
            function closeModal(modal) { dom.modalBackdrop.classList.add('hidden'); modal.classList.add('hidden'); }
            function shuffleArray(a) { for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} }

            // --- APPLICATION START ---
            init();
        });
    </script>
</body>
</html>
